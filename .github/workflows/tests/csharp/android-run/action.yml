name: Run Unit Tests Android Nuget
description: This tests the Android nuget package.
runs:
  using: composite
  steps:
    - name: Download Config
      uses: actions/download-artifact@v3
      with:
        name: config.txt
        path: ./wrappers/csharp

    - name: Download Native Libs
      uses: actions/download-artifact@v3
      with:
        name: nugets
        path: ./wrappers/csharp/tests/unit-tests/nugets/Nugets

    - name: Download Unit-test-builds
      uses: actions/download-artifact@v3
      with:
        name: unit-test-build
        path: ./wrappers/csharp/tests/unit-tests/nugets/xamarin-android/bin/Debug/

    - name: Update Nuget
      shell: bash
      run: sudo nuget update -self

    - uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'

    - name:  Setting up PATH environment variable
      shell: bash
      run: |
        echo "/usr/local/lib/android/sdk/platform-tools/" >> $GITHUB_PATH
        echo "/usr/local/lib/android/sdk/tools/bin/" >> $GITHUB_PATH
        echo "/usr/local/lib/android/sdk/emulator/" >> $GITHUB_PATH

    - name: Starting ADB Server
      shell: bash
      run: adb start-server

    - name: Install Pulseaudio # required by qemu
      shell: bash
      run: sudo apt-get install pulseaudio

    - name: Installing SDK Android-34 x86_64
      shell: bash
      run: echo "y" | sdkmanager --install "system-images;android-34;google_apis;x86_64"

    - name: Creating Android device
      shell: bash
      run: echo "no" | avdmanager create avd -n test_emulator -k "system-images;android-34;google_apis;x86_64"

    - name: Starting emulator
      shell: bash
      run: emulator @test_emulator &

    - name: Waiting for emulator to boot
      shell: bash
      run: |
        adb wait-for-device

        A=$(adb shell getprop sys.boot_completed | tr -d '\r')
        I=0
        while [ "$A" != "1" ] && [ $I -le 900 ]; do
                sleep 5
                A=$(adb shell getprop sys.boot_completed | tr -d '\r')
                ((I=I+5))
                echo "Waiting : $I seconds"
        done

        if [ $I -ge 900 ]; then
          echo "Device did not boot in 15 minutes, cancelling."
          exit 1
        else
          echo "Boot Time : $I seconds"
        fi

        adb shell input keyevent 82

    - name: Unit tests XAMARIN-ANDROID
      working-directory: ./wrappers/csharp/tests/unit-tests/nugets
      shell: bash
      run: python3 unit-tests.py -p android -a run
